<!doctype html>
<html>
<head>
    <title>Holdable - Example</title>
	<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.5.x/dist/aframe-environment-component.min.js"></script><!-- Not important -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script><!-- Not important -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.js"></script><!-- Only need if xxx -->
    <script src="https://unpkg.com/aframe-physics-extras@0.1.2/dist/aframe-physics-extras.min.js"></script><!-- Only need if xxx -->
    <script src="https://unpkg.com/aframe-haptics-component/dist/aframe-haptics-component.min.js"></script><!-- Only need if you want haptic feedback. -->
    <script src="https://cdn.jsdelivr.net/gh/MakingSpiderSense/mss-aframe-kit@main/dist/mss-aframe-kit.min.js"></script>
</head>

<body>
    <!-- Include `post-model-load-refresh` for better model compatibility. And use `raycaster-listener` if you want to have haptic feedback when grabbing objects. -->
    <a-scene
        stats
        post-model-load-refresh
        raycaster-listener
        physics="driver: local; debug: false;"
        >

        <!-- Asset Management System -->
        <a-assets>
            <a-asset-item id="sphere_robot" src="assets/360_sphere_robot.glb"></a-asset-item>
            <a-asset-item id="basketball" src="assets/basketball_blue.glb"></a-asset-item>
            <a-asset-item id="ice_cube" src="assets/ice_cube.glb"></a-asset-item>
            <a-asset-item id="couch" src="assets/couch.glb"></a-asset-item>
            <a-asset-item id="sword" src="assets/sword.glb"></a-asset-item>
            <a-asset-item id="shield" src="assets/shield.glb"></a-asset-item>
        </a-assets>

        <!-- Environment -->
        <a-entity class="env-dream" environment="preset: tron; seed: 3;"></a-entity>

        <!-- Add a fake floor - this is temporary until I can work out the floor physics with environment component -->
        <a-box position="0 0 0" width="200" height="0.1" depth="200" static-body visible="false" color="#000"></a-box>

        <!-- Box -->
        <a-box class="box-b" holdable dynamic-body sleepy="speedLimit: .7; delay: 1;" position="0 1 -.7" scale=".2 .2 .2" color="#53e4e1"></a-box>

        <!-- Model: Basketball -->
        <a-sphere class="basketball" radius=".11" holdable="position: .036 -.203 .138; rotation: -97.6 39.1 -171" body="type: dynamic; shape: sphere;" position="-1 3 0" gltf-model="#basketball"></a-sphere>

        <!-- Ice Cube -->
        <a-box class="ice_cube" holdable body="type: static; shape: box;" gltf-model="#ice_cube" depth=".8" height=".8" width=".8" position="-2.188 0.402 -0.685"></a-box>

        <!-- Sword -->
        <!-- 📝 If you see the "body not found" warning in the console, that's ok. It gets added on grab. -->
        <a-entity class="sword"
                holdable="position: 0.153 -0.520 0.219; rotation: -3.2 -3.8 -90.3; leftHandRotationInvert: y; debug: true;"
                holdable-dynamic-body
                holdable-grip-body="type: dynamic; shape: none;"
                holdable-release-body="type: dynamic; shape: none;"
                holdable-grip-animation="enabled: false;"
                holdable-release-animation="enabled: false;"
                position="3.7 1.2 -0.685"
                rotation="-90 0 0"
                shape__sword="halfExtents: 0.03 0.015 0.445; offset: -.008 0 0"
                sleepy="speedLimit: .7; delay: 1;"
                animation="property: rotation; to: -90 360 0; loop: true; dur: 10000; easing: linear">
            <!-- Actual sword mesh -->
            <a-entity gltf-model="#sword"></a-entity>
            <!-- Hidden sword scaled up to make it easier to grab -->
            <a-entity gltf-model="#sword" visible="false" scale="8 8 1.2" class="interactable"></a-entity>
        </a-entity>

        <!-- Shield -->
        <a-entity class="shield"
            gltf-model="#shield"
            holdable="position: 0.139 -0.154 0.419; rotation: -177.6 1.4 -109.7; debug: true;"
            holdable-dynamic-body
            holdable-grip-animation="enabled: false;"
            holdable-release-animation="enabled: false;"
            position="2.5 1.2 -0.685"
            rotation="90 0 0"
            animation="property: rotation; to: 90 360 0; loop: true; dur: 10000; easing: linear"
        ></a-entity>

        <!-- Couch -->
        <a-entity class="couch" holdable body="type: static; shape: none;" position="-4.43 0 -0.68" gltf-model="#couch" shape__base="halfExtents: 1 0.175 0.57; offset: 0 .195 0" shape__back="halfExtents: 0.81 0.42 0.0875; offset: 0 .429 -.486" shape__l-arm="halfExtents: 0.115 0.3 0.57; offset: -.882 .312 0" shape__r-arm="halfExtents: 0.115 0.3 0.57; offset: .883 .312 0" shape__cushion="halfExtents: 0.76 0.42 0.0875; offset: 0 .481 -.301; orientation: -.068 0 0 .998"></a-entity>

        <!-- Model: Robot - Blender & A-Frame Animation (User-facing on release) -->
        <a-entity class="sphere-robot" position="1 1.3 0" rotation="0 -10 0" holdable gltf-model="#sphere_robot"
            animation-mixer
            face-user-on-release
            holdable-grip-animation-mixer="timeScale: 0;"
            holdable-grip-animation__rotate="enabled: false;"
        ></a-entity>

		<!-- Camera Rig -->
		<a-entity class="user" position="0 0 6" movement-controls="speed: .5; constrainToNavMesh: true;">
			<!-- Camera -->
			<a-entity camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-entity>
            <!-- Controllers -->
            <a-entity class="controllers">
                <a-entity id="left-hand" hand-controls="hand: left; handModelStyle: highPoly; color: #8387ef" sphere-collider="objects: .interactable" haptics__trigger="events: trigger-vibration;">
                    <a-entity class="actual-ray" cursor rotation="-15 -90 0" raycaster="objects: .interactable; autoRefresh: false; enabled: true; far: .25; showLine: false; lineColor: red"></a-entity>
                </a-entity>
                <a-entity id="right-hand" hand-controls="hand: right; handModelStyle: highPoly; color: #8387ef" sphere-collider="objects: .interactable" haptics__trigger="events: trigger-vibration;">
                    <a-entity class="actual-ray" cursor rotation="-15 90 0" raycaster="objects: .interactable; autoRefresh: false; enabled: true; far: .25; showLine: false; lineColor: red"></a-entity>
                </a-entity>
            </a-entity>
            <!-- Oculus Controllers -->
            <!-- <a-entity class="controllers">
                <a-entity id="left-hand" oculus-touch-controls="hand: left" haptics__trigger="events: trigger-vibration;">
                    <a-cylinder class="styled-ray ar-left" visible="false" position="0 -.389 -.673" height="1.455" radius="0.002" color="#ffffff" rotation="60 0 0" opacity=".4" sound="src: #raycaster-beep; volume: .1;"></a-cylinder>
                    <a-entity class="actual-ray" cursor rotation="-30 0 0" raycaster="objects: .interactable; autoRefresh: false; enabled: true; far: .25; showLine: true; lineColor: red"></a-entity>
                </a-entity>
                <a-entity id="right-hand" oculus-touch-controls="hand: right" haptics__trigger="events: trigger-vibration;">
                    <a-cylinder class="styled-ray ar-right" visible="false" position="0 -.389 -.673" height="1.455" radius="0.002" color="#ffffff" rotation="60 0 0" opacity=".4" sound="src: #raycaster-beep; volume: .1;"></a-cylinder>
                    <a-entity class="actual-ray" cursor rotation="-30 0 0" raycaster="objects: .interactable; autoRefresh: false; enabled: true; far: .25; showLine: true; lineColor: red"></a-entity>
                </a-entity>
            </a-entity> -->
        </a-entity>

    </a-scene>

    <!-- Not important -->
    <script>
        // Face user on grip release
        // Description: On grip release, smoothly rotate the entity so that its Y rotation faces the `.user` entity.
        AFRAME.registerComponent('face-user-on-release', {
            init: function () {
                const el = this.el;
                el.addEventListener('grip-up', () => {
                    const userEl = document.querySelector('.user');
                    if (!userEl) {
                        console.warn('No .user entity found in scene.');
                        return;
                    }
                    // Get positions
                    const elPos = el.object3D.position;
                    const userPos = userEl.object3D.position;
                    // Calculate direction vector from el to user
                    const dx = userPos.x - elPos.x;
                    const dz = userPos.z - elPos.z;
                    // Y rotation in degrees, facing the user
                    const targetY = THREE.MathUtils.radToDeg(Math.atan2(dx, dz));
                    el.setAttribute('animation__faceuser', {
                        property: 'rotation',
                        to: `0 ${targetY} 0`,
                        dur: 1000,
                        easing: 'easeInOutQuad'
                    });
                });
            }
        });
    </script>

</body>
</html>