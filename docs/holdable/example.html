<!doctype html>
<html>
<head>
    <title>Holdable - Example</title>
	<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.5.x/dist/aframe-environment-component.min.js"></script><!-- Not important -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script><!-- Not important -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.js"></script><!-- Only need if xxx -->
    <script src="https://unpkg.com/aframe-physics-extras@0.1.2/dist/aframe-physics-extras.min.js"></script><!-- Only need if xxx -->
    <script src="https://unpkg.com/aframe-haptics-component/dist/aframe-haptics-component.min.js"></script><!-- Only need if xxx -->
    <script src="https://cdn.jsdelivr.net/gh/MakingSpiderSense/mss-aframe-kit@main/src/components/holdable/holdable.js"></script>
</head>

<body>
    <a-scene
        stats
        post-model-load-refresh
        physics="driver: local; debug: false;"
        >

        <!-- Asset Management System -->
        <a-assets>
            <a-asset-item id="sphere_robot" src="assets/360_sphere_robot.glb"></a-asset-item>
            <a-asset-item id="basketball" src="assets/basketball_blue.glb"></a-asset-item>
        </a-assets>

        <!-- Environment -->
        <a-entity class="env-dream" environment="preset: tron; seed: 3;"></a-entity>

        <!-- Add a fake floor - this is temporary until I can work out the floor physics with environment component -->
        <a-box position="0 0 0" width="200" height="0.1" depth="200" static-body visible="false" color="#000"></a-box>

        <!-- Box -->
        <a-box class="box-b" holdable dynamic-body sleepy="speedLimit: .7; delay: 1;" position="0 1 -.7" scale=".2 .2 .2" color="#53e4e1"></a-box>

        <!-- Model: Basketball -->
        <a-sphere class="basketball" radius=".11" holdable="position: .036 -.203 .138; rotation: -97.6 39.1 -171" body="type: dynamic; shape: sphere;" position="-1 3 0" gltf-model="#basketball"></a-sphere>

        <!-- Model: Robot - Blender & A-Frame Animation (User-facing on release) -->
        <a-entity class="sphere-robot" position="1 1.3 0" rotation="0 -10 0" holdable gltf-model="#sphere_robot"
            animation-mixer
            face-user-on-release
            holdable-grip-animation-mixer="timeScale: 0;"
            holdable-grip-animation__rotate="enabled: false;"
        ></a-entity>

		<!-- Camera Rig -->
		<a-entity class="user" position="0 0 6" movement-controls="speed: .5; constrainToNavMesh: true;">
			<!-- Camera -->
			<a-entity camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-entity>
            <!-- Controllers -->
            <a-entity class="controllers">
                <a-entity id="left-hand" hand-controls="hand: left; handModelStyle: highPoly; color: #8387ef" sphere-collider="objects: .interactable" haptics__trigger="events: trigger-vibration;">
                    <a-entity class="actual-ray" cursor rotation="-15 -90 0" raycaster="objects: .interactable; autoRefresh: false; enabled: true; far: .25; showLine: false; lineColor: red"></a-entity>
                </a-entity>
                <a-entity id="right-hand" hand-controls="hand: right; handModelStyle: highPoly; color: #8387ef" sphere-collider="objects: .interactable" haptics__trigger="events: trigger-vibration;">
                    <a-entity class="actual-ray" cursor rotation="-15 90 0" raycaster="objects: .interactable; autoRefresh: false; enabled: true; far: .25; showLine: false; lineColor: red"></a-entity>
                </a-entity>
            </a-entity>
            <!-- Oculus Controllers -->
            <!-- <a-entity class="controllers">
                <a-entity id="left-hand" oculus-touch-controls="hand: left" haptics__trigger="events: trigger-vibration;">
                    <a-cylinder class="styled-ray ar-left" visible="false" position="0 -.389 -.673" height="1.455" radius="0.002" color="#ffffff" rotation="60 0 0" opacity=".4" sound="src: #raycaster-beep; volume: .1;"></a-cylinder>
                    <a-entity class="actual-ray" cursor rotation="-30 0 0" raycaster="objects: .interactable; autoRefresh: false; enabled: true; far: .25; showLine: true; lineColor: red"></a-entity>
                </a-entity>
                <a-entity id="right-hand" oculus-touch-controls="hand: right" haptics__trigger="events: trigger-vibration;">
                    <a-cylinder class="styled-ray ar-right" visible="false" position="0 -.389 -.673" height="1.455" radius="0.002" color="#ffffff" rotation="60 0 0" opacity=".4" sound="src: #raycaster-beep; volume: .1;"></a-cylinder>
                    <a-entity class="actual-ray" cursor rotation="-30 0 0" raycaster="objects: .interactable; autoRefresh: false; enabled: true; far: .25; showLine: true; lineColor: red"></a-entity>
                </a-entity>
            </a-entity> -->
        </a-entity>

    </a-scene>

    <!-- Not important -->
    <script>
        // Face user on grip release
        // Description: On grip release, smoothly rotate the entity so that its Y rotation faces the `.user` entity.
        AFRAME.registerComponent('face-user-on-release', {
            init: function () {
                const el = this.el;
                el.addEventListener('grip-up', () => {
                    const userEl = document.querySelector('.user');
                    if (!userEl) {
                        console.warn('No .user entity found in scene.');
                        return;
                    }
                    // Get positions
                    const elPos = el.object3D.position;
                    const userPos = userEl.object3D.position;
                    // Calculate direction vector from el to user
                    const dx = userPos.x - elPos.x;
                    const dz = userPos.z - elPos.z;
                    // Y rotation in degrees, facing the user
                    const targetY = THREE.MathUtils.radToDeg(Math.atan2(dx, dz));
                    el.setAttribute('animation__faceuser', {
                        property: 'rotation',
                        to: `0 ${targetY} 0`,
                        dur: 1000,
                        easing: 'easeInOutQuad'
                    });
                });
            }
        });
    </script>

</body>
</html>